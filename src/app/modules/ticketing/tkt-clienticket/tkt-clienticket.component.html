<div class="content-wrapper">
  <div class="card">
    <div class="container-xxl container-p-y">
      <div class="misc-wrapper"> 
     <div class="filter-bar">
        <div class="filter-group">
          <label>Status</label>
          <select [(ngModel)]="selectedStatus" (change)="applyFilters()">
            <option value="all">All Status</option>
            <option *ngFor="let statuses of status" [value]="statuses.value">
              {{statuses.value}}
            </option>
          </select>
        </div>
        <div class="filter-group">
          <label>Date Range</label>
          <select [(ngModel)]="selectedDateRange" (change)="applyFilters()">
            <option value="all">All Dates</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Category</label>
          <select [(ngModel)]="selectedCategory" (change)="applyFilters()">
            <option value="all">All Categories</option>
            <option *ngFor="let category of categories" [value]="category.Category">
              {{category.Category}}
            </option>
          </select>
        </div>
        <button class="filter-btn" (click)="applyFilters()">
          <i class="bx bx-filter-alt"></i> Apply Filters
        </button>
          <button class="tktcreate-btn" (click)="openCreateTicketModal()">
            <i class="bx bx-plus"></i> Create Ticket
          </button>
        </div>

        
<div class="ticket-table-container">
  <table class="ticket-table">
    <thead>
      <tr>
        <th class="compact">TicketID</th>
        <th class="compact">Category</th>
        <th class="compact">Subject</th>
        <th class="compact">Status</th>
        <th class="compact">Created</th>
        <th class="compact">Updated</th>
        <th class="compact">Actions</th>
      </tr>
    </thead>
    <tbody *ngIf="paginatedTickets.length > 0; else noTickets">
      <tr *ngFor="let ticket of paginatedTickets">
        <td class="compact">{{ ticket.tktId }}</td>
        <td class="compact">{{ ticket.category }}</td>
        <td class="compact">{{ ticket.subject }}</td>
        <td class="compact">
          <span class="status-badge {{ ticket.statusClass }}">{{ ticket.status }}</span>
        </td>
        <td class="compact">{{ ticket.created }}</td>
        <td class="compact">{{ ticket.updated }}</td>
        <td class="compact actions">
          <button class="icon-btn" title="View" (click)="openMessageModal(ticket.tktId)">
            <i class="bx bx-show"></i>
          </button>
          <button class="icon-btn" title="Edit" (click)="viewTicket(ticket.tktId)">
            <i class="bx bx-edit"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <ng-template #noTickets>
    <tbody>
      <tr>
        <td colspan="7" style="text-align: center;">No tickets found.</td>
      </tr>
    </tbody>
  </ng-template>
</div>

<div class="pagination-controls">
  <div class="page-info">Showing {{ getFirstItemOnPage() }}-{{ getLastItemOnPage() }} of {{ tickets.length }} tickets</div>
  <div class="page-buttons">
    <button class="page-btn" [disabled]="currentPage === 1" (click)="previousPage()">
      <i class="bx bx-chevron-left"></i>
    </button>
    <span class="page-number">Page {{ currentPage }} of {{ getTotalPages() }}</span>
    <button class="page-btn" [disabled]="currentPage === getTotalPages()" (click)="nextPage()">
      <i class="bx bx-chevron-right"></i>
    </button>
  </div>
</div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showTicketModal">
  <div class="ticket-creation-modal">
    <h2>Create New Ticket</h2>

    <!-- Error message display -->
    <div class="error-message" *ngIf="error">{{ error }}</div>
    <div class="success-message" *ngIf="successMessage">{{ successMessage }}</div>
    <div class="form-group">
      <label>Subject *</label>
      <input type="text" [(ngModel)]="ticketForm.subject" placeholder="Add subject here" required>
    </div>
    <div class="form-group">
      <label>Category *</label>
      <select [(ngModel)]="ticketForm.catId" (change)="onCategoryChange($event)">
        <option value="">Select a category</option>
        <option *ngFor="let category of categories" [value]="category.CatId">
          {{category.CatId}} - {{category.Category}}
        </option>
      </select>
    </div>
    <div class="form-group">
      <label>Description *</label>
      <textarea type="text" [(ngModel)]="ticketForm.description" placeholder="Brief description of your issue"></textarea>
      <div class="char-count">
        <span>{{ ticketForm.description.length || 0 }}/500</span>
        <span *ngIf="ticketForm.description.length > 500" class="error-text">Character limit exceeded!</span>
      </div>
    </div>

    <div class="modal-actions">
      <button class="cancel-btn" (click)="showTicketModal = false">Cancel</button>
      <button class="submit-btn" (click)="createTicket()" [disabled]="submitting">
        {{ submitting ? 'Creating...' : 'Create Ticket' }}
      </button>
    </div>
  </div>
</div>


<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="close-modal-btn" (click)="closeModal()">
      <i class='bx bx-x'></i>
    </button>
    
    <div class="ticket-header">
      <div class="priority-badge {{selectedTicket?.Priority?.toLowerCase() || 'low'}}">
        {{selectedTicket?.Priority || 'Low'}} Priority
      </div>
      <div class="ticket-id">Ticket #{{selectedTicket?.tktId}}</div>
      <div class="ticket-status">
        <span class="status-label">Status</span>
        <div class="status-display {{getStatusDropdownClass(selectedTicket?.Status)}}" 
             *ngIf="selectedTicket?.Status === 'Closed'">
          {{selectedTicket?.Status}}
        </div>
        <div class="status-dropdown {{getStatusDropdownClass(selectedTicket?.Status)}}" 
             *ngIf="selectedTicket?.Status !== 'Closed'">
          <select class="status-select"
            [(ngModel)]="selectedTicket.Status"
            (change)="updateTicketStatus(selectedTicket)">
            <option *ngFor="let option of status" [value]="option.value">
              {{ option.value }}
            </option>
          </select>
          <i class='bx bx-chevron-down dropdown-icon'></i>
        </div>
      </div>
    </div>

    <h2 class="ticket-subject">{{selectedTicket?.subject}}</h2>
    <h4 class="ticket-description"><span>Description:</span>{{selectedTicket?.description}}</h4>

    <div class="ticket-meta">
      <div class="meta-item">
        <span class="meta-label">Category:</span>
        <span class="meta-value">{{selectedTicket?.tktCategory}}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">Created:</span>
        <span class="meta-value">{{formatDate(selectedTicket?.created)}}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">Updated:</span>
        <span class="meta-value">{{formatDate(selectedTicket?.updated)}}</span>
      </div>
    </div>  

    <!-- Scrollable Conversation Area -->
    <div class="conversation-container">
      <div class="conversation-thread">
        <!-- Your existing message boxes -->
        <div class="message-box message-left user-message">
          <div class="message-header">
            <div class="message-sender">
              <span class="name">{{selectedTicket?.client.ClientName}}</span>
              <span class="role">{{selectedTicket?.client.Role}}</span> 
            </div>
            <span class="time">10:30 AM</span>
          </div>
          <div class="message-body">
            <p>Hello, I'm having issues with my login credentials.</p>
          </div>
        </div>

        <div class="message-box message-right support-message">
          <div class="message-header">
            <div class="message-sender">
              <span class="name">Support Team</span>
              <span class="role">Technical Support</span> 
            </div>
            <span class="time">10:35 AM</span>
          </div>
          <div class="message-body">
            <p>We're looking into your issue and will get back to you shortly.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="response-section" *ngIf="selectedTicket?.Status !== 'Closed'">
      <div class="attachments-preview">
        <div class="attachment-preview">
          <span>screenshot.png</span>
          <button class="remove-attachment">
            <i class='bx bx-x'></i>
          </button>
        </div>
      </div>
      
      <div class="response-input-container">
        <input type="text" placeholder="Type your response here..." />
        <div class="response-actions">
          <label for="fileInput" class="attachment-btn" title="Attach file">
            <i class='bx bx-paperclip'></i>
            <input id="fileInput" type="file" multiple style="display: none;">
          </label>
          <button class="send-btn">
            Send <i class='bx bx-send'></i>
          </button>
        </div>
      </div>
    </div>

    <!-- View-only message when ticket is closed -->
    <div class="view-only-message" *ngIf="selectedTicket?.Status === 'Closed'">
      <p>This ticket is closed and cannot be modified.</p>
    </div>
  </div>
</div>